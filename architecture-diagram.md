# Dify on Google Cloud - アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              インターネット                                 │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
                                   │ HTTPS (443)
                                   │
┌──────────────────────────────────▼──────────────────────────────────────────┐
│                        Google Cloud Load Balancer                           │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │  • Global Static IP                                                │     │
│  │  • SSL Termination (Managed Certificate or Self-Signed)            │     │
│  │  • HTTPS Proxy                                                     │     │
│  │  • URL Map                                                         │     │
│  │  • Health Check (Port 1080, Path: /health)                         │     │
│  └────────────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │
                                   │ HTTP (1080)
                                   │
┌──────────────────────────────────▼──────────────────────────────────────────┐
│                      VPC Network (Custom VPC)                               │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                  Subnet (カスタム CIDR レンジ)                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │            Managed Instance Group (Auto-Scaling)                        ││
│  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                ││
│  │  │  Compute      │  │  Compute      │  │  Compute      │                ││
│  │  │  Engine VM    │  │  Engine VM    │  │  Engine VM    │                ││
│  │  │               │  │               │  │               │                ││
│  │  │  • Ubuntu     │  │  • Ubuntu     │  │  • Ubuntu     │  + 自動追加    ││
│  │  │  • Docker     │  │  • Docker     │  │  • Docker     │                ││
│  │  │  • Dify       │  │  • Dify       │  │  • Dify       │                ││
│  │  │  • Port 1080  │  │  • Port 1080  │  │  • Port 1080  │                ││
│  │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘                ││
│  │          │                  │                  │                        ││
│  │          └──────────────────┴──────────────────┘                        ││
│  │                             │                                           ││
│  │          ┌──────────────────┴──────────────────┐                        ││
│  │          │   Service Account (IAM)             │                        ││
│  │          │   • Storage Admin権限               │                        ││
│  │          │   • Cloud SQL Client権限            │                        ││
│  │          │   • Redis Client権限                │                        ││
│  │          └─────────────────────────────────────┘                        ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  ┌──────────────────┐    ┌──────────────────┐    ┌────────────────────────┐ │
│  │                  │    │                  │    │                        │ │
│  │  Cloud SQL       │    │  Cloud SQL       │    │  Memorystore           │ │
│  │  (PostgreSQL)    │    │  (PostgreSQL)    │    │  for Redis             │ │
│  │                  │    │                  │    │                        │ │
│  │  • メインDB      │    │  • pgvector拡張  │    │  • キャッシュ          │ │
│  │  • バックアップ  │    │  • ベクトル検索  │    │  • セッション管理      │ │
│  │  • HA対応        │    │  • 埋め込みストア│    │  • AUTH認証対応        │ │
│  │  • Private IP    │    │  • Private IP    │    │  • Private IP          │ │
│  │                  │    │                  │    │  • HA対応 (Optional)   │ │
│  │                  │    │                  │    │  • RDB永続化 (Optional)│ │
│  └──────────────────┘    └──────────────────┘    └────────────────────────┘ │
│           ▲                       ▲                         ▲               │
│           │                       │                         │               │
│           └───────────────────────┴─────────────────────────┘               │
│                        Private Service Connection                           │
│                        (VPC Peering)                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                     Google Cloud Storage (GCS)                               │
│  ┌────────────────────────────────────────────────────────────────────┐      │
│  │  • ファイルアップロード保存                                        │      │
│  │  • CORS設定対応                                                    │      │
│  │  • バージョニング対応                                              │      │
│  │  • ライフサイクルポリシー                                          │      │
│  │  • Service Accountによる認証                                       │      │
│  └────────────────────────────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                          Firewall Rules                                      │
│  ┌────────────────────────────────────────────────────────────────────┐      │
│  │  • Allow LB → Instances (Port 1080, 443)                           │      │
│  │  • Allow Health Check (Google IP Ranges)                           │      │
│  │  • Allow SSH (設定可能な送信元IPレンジ)                            │      │
│  └────────────────────────────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────────────────────────────┘
```

## アーキテクチャの主要コンポーネント

### 1. ネットワーク層
- **VPC Network**: カスタムモードのVPCネットワーク
- **Subnet**: リージョナルサブネット（カスタムCIDR）
- **Firewall Rules**: 
  - ロードバランサーからのHTTP/HTTPSトラフィック許可
  - ヘルスチェックトラフィック許可
  - SSH接続許可（IP制限可能）
- **Static IP**: ロードバランサー用のグローバル静的IP

### 2. コンピューティング層
- **Managed Instance Group (MIG)**:
  - Ubuntu 22.04 LTS
  - Dockerコンテナ（Dify）
  - 自動スケーリング機能
  - 自動ヒーリング機能
  - ローリングアップデート対応
- **Instance Template**: 起動スクリプトによる自動セットアップ

### 3. ロードバランサー層
- **Global HTTP(S) Load Balancer**:
  - SSL/TLS終端処理
  - マネージドSSL証明書 or 自己署名証明書
  - ヘルスチェック（Port 1080, /health）
  - バックエンドサービス

### 4. データベース層
- **Cloud SQL (メインDB)**:
  - PostgreSQL
  - プライベートIPアクセス
  - 自動バックアップ
  - ポイントインタイムリカバリ
  - 高可用性構成オプション
  
- **Cloud SQL (pgvector)**:
  - PostgreSQL + pgvector拡張機能
  - ベクトル埋め込み保存
  - 類似検索機能

### 5. キャッシュ層
- **Memorystore for Redis**:
  - キャッシング
  - セッション管理
  - プライベートIPアクセス
  - Redis AUTH認証オプション
  - 高可用性構成オプション
  - RDB永続化オプション

### 6. ストレージ層
- **Cloud Storage (GCS)**:
  - ファイルアップロード保存
  - CORS設定
  - バージョニング
  - ライフサイクル管理

### 7. IAM・セキュリティ層
- **Service Account**:
  - Compute EngineインスタンスのID
  - Cloud Storage管理権限
  - Cloud SQLクライアント権限
  - Redis接続権限

## データフロー

1. **ユーザーリクエスト**:
   - ユーザー → ロードバランサー (HTTPS/443)
   - ロードバランサー → MIG内のインスタンス (HTTP/1080)

2. **データベースアクセス**:
   - Difyアプリケーション → Cloud SQL (メイン) - Private IP
   - Difyアプリケーション → Cloud SQL (pgvector) - Private IP

3. **キャッシュアクセス**:
   - Difyアプリケーション → Redis - Private IP

4. **ファイルストレージ**:
   - Difyアプリケーション → Cloud Storage (Service Account認証)

## セキュリティ特性

- **ネットワーク分離**: Private Service Connectionによるプライベートアクセス
- **暗号化**: 
  - HTTPS通信（SSL/TLS）
  - データベース暗号化
  - Redis Transit Encryption（オプション）
- **認証**: 
  - Service Account認証
  - Redis AUTH（オプション）
- **アクセス制御**: 
  - IAMロールベースアクセス
  - ファイアウォールルール
  - SSH IP制限

## スケーラビリティ

- **水平スケーリング**: MIGの自動スケーリング（CPU使用率ベース）
- **垂直スケーリング**: インスタンスタイプ変更可能
- **データベーススケーリング**: Cloud SQLのマシンタイプ・ディスクサイズ調整
- **Redisスケーリング**: メモリサイズ調整

## 高可用性

- **Load Balancer**: グローバルロードバランサー
- **MIG**: マルチゾーン配置対応
- **Cloud SQL**: リージョナルHA構成オプション
- **Redis**: Standard HA ティアでレプリカ対応
- **Auto Healing**: ヘルスチェックによる自動復旧
